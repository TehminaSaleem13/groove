require 'rails_helper'

describe OrdersController do
  before(:each) do
    # Groovepacker::SeedTenant.new.seed

    @user_role = FactoryGirl.create(:role,:name=>'order_import_spec_tester_role')
    @user = FactoryGirl.create(:user,:name=>'Order Import Tester', :username=>"order_import_spec_tester", :role => @user_role)
    sign_in @user
    @access_restriction = FactoryGirl.create(:access_restriction)
    @access_restriction.inspect
  end

  # it "imports orders for amazon store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'amazon_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'amazon_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Amazon')
  #   @amazon_credentials = FactoryGirl.create(:amazon_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :importorders, {:id => @store.id}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  #   expect(result['status']).to eq(true)
  #   expect(result['messages']).to eq([])
  # end
  # it "imports orders for ebay store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'ebay_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'ebay_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Ebay')
  #   @ebay_credentials = FactoryGirl.create(:ebay_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :importorders, {:id => @store.id}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  #   expect(result['status']).to eq(true)
  #   expect(result['messages']).to eq([])
  # end
  # it "imports orders for magento store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'magento_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'magento_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Magento')
  #   @magento_credentials = FactoryGirl.create(:magento_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :importorders, {:id => @store.id}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  #   expect(result['status']).to eq(true)
  #   expect(result['messages']).to eq([])
  # end
  # it "imports orders for shipstation store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipstation_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'shipstation_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Shipstation')
  #   @shipstation_credentials = FactoryGirl.create(:shipstation_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :importorders, {:id => @store.id}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  #   expect(result['status']).to eq(true)
  #   expect(result['messages']).to eq([])
  # end
  # it "imports orders for shipstation API 2 store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipstation_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'shipstation_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Shipstation API 2')
  #   @shipstation_rest_credentials = FactoryGirl.create(:shipstation_rest_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :importorders, {:id => @store.id}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  #   expect(result['status']).to eq(true)
  #   expect(result['messages']).to eq([])
  # end
  # it "imports orders for shipworks store" do
  #   @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
  #   @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :store_type=> 'Shipworks')
  #   @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id)
  #   request.accept = "application/json"
  #   post :import_shipworks, {auth_token: @shipworks_credentials.auth_token}
  #   expect(response.status).to eq(200)
  #   result = JSON.parse(response.body)
  # end
  it "imports order successfully if shall_import_no_status is true and order Status is nil" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_no_status=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>nil, "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
  end
  
  it "order import fails if shall_import_no_status is false and order Status is nil" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_no_status=>false)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>nil, "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('failed')
  end

  it "order import succeeds if shall_import_new_order is true and order Status is New Order" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_new_order=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>'New Order', "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
  end

  it "order import succeeds if shall_import_in_process is true and order Status is In Process" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_in_process=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>'In Process', "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
  end

  it "order import succeeds if shall_import_not_shipped is true and order Status is Not Shipped" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_not_shipped=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>'Not Shipped', "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
  end

  it "order import succeeds if shall_import_shipped is true and order Status is Shipped" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_shipped=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>'Shipped', "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
  end

  it "import product along with order" do
    @inv_wh = FactoryGirl.create(:inventory_warehouse, :name=>'shipworks_inventory_warehouse')
    @store = FactoryGirl.create(:store, :name=>'shipworks_store', :inventory_warehouse=>@inv_wh, :status => true)
    @shipworks_credentials = FactoryGirl.create(:shipworks_credential, :store_id=>@store.id, :shall_import_no_status=>true)
    request.accept = "application/json"
    request.headers["HTTP_USER_AGENT"].clear
    request.headers["HTTP_USER_AGENT"] << 'shipworks'
    @ShipWorks = {"Generated"=>"2015-01-02T15:04:01.8181451Z", "Timestamp"=>"1420211041", "UniqueID"=>"\n{fcee995d-bf3d-465f-93de-7b864be7929b}\n", "Context"=>"Order", "Template"=>{"Name"=>"XML Source", "Folder"=>"System\nUtility", "Output"=>{"ContentWidth"=>"7", "ContentHeight"=>"9.5"}}, "User"=>{"ID"=>"1027309002", "Username"=>"System", "IsAdmin"=>"true"}, "Store"=>{"ID"=>"3005", "StoreName"=>"GroovePackerMagento", "StoreType"=>{"ID"=>"21", "Code"=>"MAGENTO", "Name"=>"Magento"}, "LastDownload"=>"2015-01-02T14:52:41.563Z", "Address"=>{"type"=>"company", "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}}, "Customer"=>{"ID"=>"10814012", "Summary"=>{"TotalSpent"=>"21.8300", "OrdersPlaced"=>"1"}, "Address"=>[{"type"=>"ship", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>nil, "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Order"=>{"ID"=>"14037006", "storeID"=>"3005", "Number"=>"100014703", "Date"=>"2013-01-10T21:44:23Z", "Status"=>nil, "OnlineStatus"=>"Complete", "OnlineStatusCode"=>"complete", "OnlineCustomerID"=>"13064", "IsManual"=>"false", "RequestedShipping"=>"United States Postal Service - First-Class Mail Pa", "Total"=>"21.8300", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"bill", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}], "Item"=>{"ID"=>"39130013", "Name"=>"DreadHead Dreadlocks Wax", "Code"=>"P-WAX", "SKU"=>"P-WAX", "Description"=>nil, "Location"=>nil, "ISBN"=>nil, "UPC"=>nil, "Thumbnail"=>nil, "Image"=>nil, "UnitPrice"=>"15", "UnitPriceWithOptions"=>"15", "UnitCost"=>"0", "Weight"=>"0.4", "Quantity"=>"1", "TotalPrice"=>"15", "TotalPriceWithOptions"=>"15", "TotalCost"=>"0", "TotalWeight"=>"0.4", "Status"=>nil, "IsManual"=>"false"}, "Charge"=>[{"ID"=>"15951021", "Type"=>"SHIPPING", "Description"=>"Shipping and Handling", "Amount"=>"5.6300"}, {"ID"=>"15952021", "Type"=>"TAX", "Description"=>"Tax", "Amount"=>"1.2000"}], "Payment"=>{"Detail"=>{"ID"=>"15395023", "Label"=>"Payment Type", "Value"=>"Credit Card (Authorize.net)"}}, "Shipment"=>{"ID"=>"20114031", "ShipmentType"=>"None", "Status"=>"None", "Processed"=>"false", "ProcessedDate"=>nil, "Voided"=>"false", "VoidedDate"=>nil, "ShippedDate"=>"2015-01-02T12:00:00Z", "ServiceUsed"=>nil, "ReturnShipment"=>"false", "TrackingNumber"=>nil, "TotalCharges"=>"0", "TotalWeight"=>"0.4", "Address"=>[{"type"=>"ship", "FullName"=>"quincy walker", "FirstName"=>"Quincy", "MiddleName"=>nil, "LastName"=>"Walker", "Company"=>nil, "Line1"=>"216 Loquat Ct", "Line2"=>nil, "Line3"=>nil, "City"=>"Myrtle Beach", "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>"29579", "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>"803 431 3801", "Fax"=>nil, "Email"=>"qlwalker1@gmail.com", "Website"=>nil}, {"type"=>"from", "FullName"=>nil, "FirstName"=>"GroovePackerMagento", "MiddleName"=>nil, "LastName"=>nil, "Company"=>"DreadHeadHQ", "Line1"=>nil, "Line2"=>nil, "Line3"=>nil, "City"=>nil, "StateCode"=>"SC", "StateName"=>"South Carolina", "PostalCode"=>nil, "CountryCode"=>"US", "CountryName"=>"United States", "Phone"=>nil, "Fax"=>nil, "Email"=>"support@dreadheadhq.com", "Website"=>"http://www.groovepacker.com/store/"}], "BestRateEvent"=>"None", "ShipSense"=>{"Status"=>"a", "ChangeSets"=>nil}, "RequestedLabelFormat"=>"Standard"}}}}
    post :import_shipworks, {:auth_token => @shipworks_credentials.auth_token, :ShipWorks=>@ShipWorks}
    expect(response.status).to eq(200)
    credential = ShipworksCredential.find_by_auth_token(@shipworks_credentials.auth_token)
    import_item = ImportItem.find_by_store_id(credential.store.id)
    expect(import_item.status).to eq('completed')
    expect(import_item.success_imported).to eq(1)
    product = Product.last
    expect(product.name).to eq(@ShipWorks['Customer']['Order']['Item']['Name'])
    expect(product.store_product_id).to eq(@ShipWorks['Customer']['Order']['Item']['ID'])
    expect(product.weight.to_s).to eq(@ShipWorks['Customer']['Order']['Item']['Weight'])
  end
end
